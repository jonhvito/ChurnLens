name: Deploy to Homelab

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    name: Build and Deploy
    runs-on: self-hosted
    
    steps:
      - name: ğŸ“¥ Atualizar cÃ³digo
        run: |
          cd /home/jonh/apps/ChurnLens
          git fetch origin
          git reset --hard origin/main
          git clean -fd
      
      - name: ğŸ”§ Verificar Docker
        run: |
          docker --version
          docker compose version
      
      - name: ğŸ›‘ Parar containers antigos
        run: |
          cd /home/jonh/apps/ChurnLens
          docker compose down || true
        continue-on-error: true
      
      - name: ğŸ—ï¸ Build da imagem
        run: |
          cd /home/jonh/apps/ChurnLens
          docker compose build --no-cache
      
      - name: ğŸš€ Deploy da aplicaÃ§Ã£o
        run: |
          cd /home/jonh/apps/ChurnLens
          docker compose up -d
      
      - name: ğŸ“Š Verificar status
        run: |
          cd /home/jonh/apps/ChurnLens
          sleep 5
          docker compose ps
          docker compose logs --tail 20
      
      - name: ğŸ§¹ Limpar imagens antigas
        run: |
          docker image prune -f
        continue-on-error: true
      
      - name: âœ… Deploy concluÃ­do
        run: |
          echo "ğŸ‰ Deploy realizado com sucesso!"
          echo "ğŸŒ AplicaÃ§Ã£o disponÃ­vel em: https://churnlens.jonhvito.com.br"
