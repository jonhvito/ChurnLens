{% extends "base.html" %}

{% block title %}Dashboard - ChurnLens{% endblock %}

{% block content %}
<!-- Introduction Section -->
<div class="bg-gradient-to-r from-blue-600 to-indigo-700 rounded-lg shadow-lg p-6 mb-8 text-white">
    <h1 class="text-3xl font-bold mb-3">üîç ChurnLens - An√°lise de Churn de Clientes</h1>
    <p class="text-lg mb-2">
        <strong>Objetivo:</strong> Identificar clientes com alta probabilidade de abandono (churn) usando an√°lise RFM e
        segmenta√ß√£o de risco.
    </p>
    <p class="text-sm opacity-90 mb-4">
        Esta aplica√ß√£o analisa o comportamento de compra dos clientes da base Olist (e-commerce brasileiro) para prever
        quais clientes est√£o em risco de n√£o retornarem.
        A an√°lise considera clientes inativos por mais de 270 dias como "em churn".
    </p>

    <!-- Gloss√°rio de Siglas -->
    <div class="bg-white bg-opacity-10 rounded p-4 mt-4">
        <h3 class="font-bold mb-2">üìö Gloss√°rio de Siglas:</h3>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-2 text-sm">
            <div><strong>RFM:</strong> Recency (Rec√™ncia), Frequency (Frequ√™ncia), Monetary (Monet√°rio)</div>
            <div><strong>KPI:</strong> Key Performance Indicator (Indicador-chave de Performance)</div>
            <div><strong>Churn:</strong> Taxa de abandono/cancelamento de clientes</div>
            <div><strong>CSV:</strong> Comma-Separated Values (arquivo de dados em formato tabular)</div>
        </div>
    </div>

    <!-- Bot√£o de Ajuda -->
    <button onclick="toggleHelpModal()"
        class="mt-4 bg-white bg-opacity-20 hover:bg-opacity-30 text-white font-medium py-2 px-4 rounded inline-flex items-center transition-all">
        <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd"
                d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-8-3a1 1 0 00-.867.5 1 1 0 11-1.731-1A3 3 0 0113 8a3.001 3.001 0 01-2 2.83V11a1 1 0 11-2 0v-1a1 1 0 011-1 1 1 0 100-2zm0 8a1 1 0 100-2 1 1 0 000 2z"
                clip-rule="evenodd"></path>
        </svg>
        Saiba Mais sobre a Metodologia RFM
    </button>
</div>

<!-- Modal de Expans√£o de Gr√°fico -->
<div id="chartModal" class="fixed inset-0 bg-black bg-opacity-75 hidden items-center justify-center z-50 p-4"
    onclick="closeChartModal()">
    <div class="bg-white dark:bg-gray-800 rounded-lg w-full h-full max-w-[90vw] max-h-[85vh] flex flex-col"
        onclick="event.stopPropagation()">
        <div
            class="flex justify-between items-center px-6 py-2 border-b border-gray-200 dark:border-gray-700 flex-shrink-0">
            <h2 id="chartModalTitle" class="text-xl font-bold text-gray-900 dark:text-white"></h2>
            <button onclick="closeChartModal()"
                class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-300">
                <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd"
                        d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z"
                        clip-rule="evenodd"></path>
                </svg>
            </button>
        </div>
        <div class="flex-1 p-4 overflow-hidden" style="height: calc(100% - 50px);">
            <div class="chart-container-expanded" style="position: relative; height: 100%; width: 100%;">
                <canvas id="expandedChart"></canvas>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Ajuda -->
<div id="helpModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50"
    onclick="toggleHelpModal()">
    <div class="bg-white dark:bg-gray-800 rounded-lg p-8 max-w-4xl max-h-[90vh] overflow-y-auto m-4"
        onclick="event.stopPropagation()">
        <div class="flex justify-between items-start mb-6">
            <h2 class="text-2xl font-bold text-gray-900 dark:text-white">üìñ Entendendo a Metodologia RFM</h2>
            <button onclick="toggleHelpModal()"
                class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-300">
                <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd"
                        d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z"
                        clip-rule="evenodd"></path>
                </svg>
            </button>
        </div>

        <div class="space-y-6">
            <!-- RFM Explica√ß√£o -->
            <div>
                <h3 class="text-xl font-bold text-blue-700 dark:text-blue-400 mb-3">üéØ O que √© RFM?</h3>
                <p class="text-gray-700 dark:text-gray-300 mb-3">
                    <strong>RFM</strong> √© um m√©todo de segmenta√ß√£o de clientes baseado em tr√™s dimens√µes do
                    comportamento de compra:
                </p>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                    <div class="bg-blue-50 dark:bg-blue-900/30 p-4 rounded border-l-4 border-blue-500">
                        <h4 class="font-bold text-blue-900 dark:text-blue-100 mb-2">üìÖ Recency (Rec√™ncia)</h4>
                        <p class="text-sm text-gray-700 dark:text-gray-300">H√° quantos dias o cliente fez a √∫ltima
                            compra?</p>
                        <p class="text-xs text-gray-600 dark:text-gray-400 mt-2"><em>Quanto mais recente, melhor</em>
                        </p>
                    </div>
                    <div class="bg-green-50 dark:bg-green-900/30 p-4 rounded border-l-4 border-green-500">
                        <h4 class="font-bold text-green-900 dark:text-green-100 mb-2">üîÑ Frequency (Frequ√™ncia)</h4>
                        <p class="text-sm text-gray-700 dark:text-gray-300">Quantas vezes o cliente comprou?</p>
                        <p class="text-xs text-gray-600 dark:text-gray-400 mt-2"><em>Quanto mais frequente, melhor</em>
                        </p>
                    </div>
                    <div class="bg-yellow-50 dark:bg-yellow-900/30 p-4 rounded border-l-4 border-yellow-500">
                        <h4 class="font-bold text-yellow-900 dark:text-yellow-100 mb-2">üí∞ Monetary (Monet√°rio)</h4>
                        <p class="text-sm text-gray-700 dark:text-gray-300">Quanto dinheiro o cliente gastou no total?
                        </p>
                        <p class="text-xs text-gray-600 dark:text-gray-400 mt-2"><em>Quanto maior o valor, melhor</em>
                        </p>
                    </div>
                </div>
            </div>

            <!-- Scoring -->
            <div>
                <h3 class="text-xl font-bold text-purple-700 dark:text-purple-400 mb-3">üî¢ Como funciona a Pontua√ß√£o?
                </h3>
                <p class="text-gray-700 dark:text-gray-300 mb-3">
                    Cada dimens√£o (R, F, M) recebe uma pontua√ß√£o de <strong>1 a 5</strong> usando quintis:
                </p>
                <ul class="list-disc list-inside text-gray-700 dark:text-gray-300 space-y-2 mb-3">
                    <li><strong>Score 5:</strong> Top 20% (melhores clientes nesta dimens√£o)</li>
                    <li><strong>Score 4:</strong> 20-40% seguintes</li>
                    <li><strong>Score 3:</strong> 40-60% (mediano)</li>
                    <li><strong>Score 2:</strong> 60-80%</li>
                    <li><strong>Score 1:</strong> Bottom 20% (piores clientes nesta dimens√£o)</li>
                </ul>
                <div class="bg-purple-50 dark:bg-purple-900/30 p-4 rounded border-l-4 border-purple-500">
                    <p class="text-gray-700 dark:text-gray-300 font-bold mb-2">C√°lculo do RFM Score Final:</p>
                    <p class="text-gray-700 dark:text-gray-300">RFM Score = <strong>(R + F + M) √∑ 3</strong></p>
                    <p class="text-sm text-gray-600 dark:text-gray-400 mt-2">
                        Exemplo: Cliente com R=5, F=3, M=4 ‚Üí RFM Score = (5+3+4)/3 = <strong>4.0</strong>
                    </p>
                    <p class="text-sm text-gray-600 dark:text-gray-400 mt-2">
                        ‚ö†Ô∏è Clientes com RFM Score <strong>1.0-2.0</strong> t√™m <strong>alto risco de churn</strong>.<br>
                        ‚úÖ Clientes com RFM Score <strong>4.0-5.0</strong> s√£o os mais valiosos e engajados.
                    </p>
                </div>
            </div>

            <!-- Churn Definition -->
            <div>
                <h3 class="text-xl font-bold text-red-700 dark:text-red-400 mb-3">‚ö†Ô∏è Defini√ß√£o de Churn</h3>
                <p class="text-gray-700 dark:text-gray-300 mb-2">
                    Um cliente √© considerado <strong>"em churn"</strong> quando:
                </p>
                <div class="bg-red-50 dark:bg-red-900/30 p-4 rounded border-l-4 border-red-500">
                    <p class="font-bold text-red-900 dark:text-red-100">Rec√™ncia > 270 dias</p>
                    <p class="text-sm text-gray-700 dark:text-gray-300 mt-2">
                        Ou seja, n√£o realizou nenhuma compra nos √∫ltimos 9 meses (aproximadamente).
                        Este √© o limiar configur√°vel usado nesta an√°lise.
                    </p>
                </div>
            </div>

            <!-- Risk Segments -->
            <div>
                <h3 class="text-xl font-bold text-orange-700 dark:text-orange-400 mb-3">üéöÔ∏è Segmentos de Risco</h3>
                <p class="text-gray-700 dark:text-gray-300 mb-3">
                    Com base no RFM Score, os clientes s√£o divididos em <strong>8 segmentos de risco</strong> (1 = menor
                    risco, 8 = maior risco).
                    Esta segmenta√ß√£o permite priorizar a√ß√µes de reten√ß√£o nos grupos mais cr√≠ticos.
                </p>
            </div>

            <!-- Use Cases -->
            <div>
                <h3 class="text-xl font-bold text-indigo-700 dark:text-indigo-400 mb-3">üí° Como Usar Esta An√°lise?</h3>
                <ul class="list-disc list-inside text-gray-700 dark:text-gray-300 space-y-2">
                    <li><strong>Campanhas de Reten√ß√£o:</strong> Focar nos Top 50 em Risco com ofertas personalizadas
                    </li>
                    <li><strong>Win-back:</strong> Reativar clientes inativos (rec√™ncia alta) com descontos</li>
                    <li><strong>Recompensas VIP:</strong> Premiar clientes com RFM Score alto (5) para manter lealdade
                    </li>
                    <li><strong>Monitoramento:</strong> Acompanhar a Taxa de Churn ao longo do tempo</li>
                </ul>
            </div>
        </div>

        <div class="mt-6 flex justify-end">
            <button onclick="toggleHelpModal()"
                class="bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-6 rounded">
                Entendi!
            </button>
        </div>
    </div>
</div>

<!-- KPIs Section -->
<div class="mb-4">
    <h2 class="text-2xl font-bold text-gray-800 dark:text-white mb-2">üìä Indicadores-Chave (KPIs)</h2>
    <p class="text-gray-600 dark:text-gray-400">M√©tricas principais que resumem a sa√∫de da base de clientes</p>
</div>
<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6 hover:shadow-lg transition-shadow"
        title="N√∫mero total de clientes √∫nicos na base de dados">
        <div class="flex items-center">
            <div class="flex-1">
                <p class="text-sm font-medium text-gray-600 dark:text-gray-400">Total de Clientes</p>
                <p class="text-xs text-gray-500 dark:text-gray-500 mt-1">Clientes √∫nicos analisados</p>
                <p class="text-3xl font-bold text-gray-900 dark:text-white" id="kpi-total-customers">
                    {{ kpis.total_customers | default('...', true) }}
                </p>
            </div>
            <div class="ml-4 text-blue-500">
                <svg class="w-12 h-12" fill="currentColor" viewBox="0 0 20 20">
                    <path
                        d="M9 6a3 3 0 11-6 0 3 3 0 016 0zM17 6a3 3 0 11-6 0 3 3 0 016 0zM12.93 17c.046-.327.07-.66.07-1a6.97 6.97 0 00-1.5-4.33A5 5 0 0119 16v1h-6.07zM6 11a5 5 0 015 5v1H1v-1a5 5 0 015-5z">
                    </path>
                </svg>
            </div>
        </div>
    </div>

    <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6 hover:shadow-lg transition-shadow"
        title="Percentual de clientes que n√£o compraram nos √∫ltimos 270 dias">
        <div class="flex items-center">
            <div class="flex-1">
                <p class="text-sm font-medium text-gray-600 dark:text-gray-400">Taxa de Churn</p>
                <p class="text-xs text-gray-500 dark:text-gray-500 mt-1">% inativos >270 dias</p>
                <p class="text-3xl font-bold text-red-600 dark:text-red-500" id="kpi-churn-rate">
                    {{ kpis.churn_rate | default('...', true) }}%
                </p>
            </div>
            <div class="ml-4 text-red-500">
                <svg class="w-12 h-12" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd"
                        d="M3 3a1 1 0 00-1 1v12a1 1 0 102 0V4a1 1 0 00-1-1zm10.293 9.293a1 1 0 001.414 1.414l3-3a1 1 0 000-1.414l-3-3a1 1 0 10-1.414 1.414L14.586 9H7a1 1 0 100 2h7.586l-1.293 1.293z"
                        clip-rule="evenodd"></path>
                </svg>
            </div>
        </div>
    </div>

    <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6 hover:shadow-lg transition-shadow"
        title="Soma de todos os valores pagos pelos clientes">
        <div class="flex items-center">
            <div class="flex-1">
                <p class="text-sm font-medium text-gray-600 dark:text-gray-400">Receita Total</p>
                <p class="text-xs text-gray-500 dark:text-gray-500 mt-1">Valor total transacionado</p>
                <p class="text-3xl font-bold text-green-600 dark:text-green-500" id="kpi-revenue">
                    R$ {{ "%.2f" | format(kpis.total_revenue | default(0, true) / 1000) }}K
                </p>
            </div>
            <div class="ml-4 text-green-500">
                <svg class="w-12 h-12" fill="currentColor" viewBox="0 0 20 20">
                    <path
                        d="M8.433 7.418c.155-.103.346-.196.567-.267v1.698a2.305 2.305 0 01-.567-.267C8.07 8.34 8 8.114 8 8c0-.114.07-.34.433-.582zM11 12.849v-1.698c.22.071.412.164.567.267.364.243.433.468.433.582 0 .114-.07.34-.433.582a2.305 2.305 0 01-.567.267z">
                    </path>
                    <path fill-rule="evenodd"
                        d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-13a1 1 0 10-2 0v.092a4.535 4.535 0 00-1.676.662C6.602 6.234 6 7.009 6 8c0 .99.602 1.765 1.324 2.246.48.32 1.054.545 1.676.662v1.941c-.391-.127-.68-.317-.843-.504a1 1 0 10-1.51 1.31c.562.649 1.413 1.076 2.353 1.253V15a1 1 0 102 0v-.092a4.535 4.535 0 001.676-.662C13.398 13.766 14 12.991 14 12c0-.99-.602-1.765-1.324-2.246A4.535 4.535 0 0011 9.092V7.151c.391.127.68.317.843.504a1 1 0 101.511-1.31c-.563-.649-1.413-1.076-2.354-1.253V5z"
                        clip-rule="evenodd"></path>
                </svg>
            </div>
        </div>
    </div>

    <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6 hover:shadow-lg transition-shadow"
        title="Data usada como ponto de corte para calcular rec√™ncia e churn">
        <div class="flex items-center">
            <div class="flex-1">
                <p class="text-sm font-medium text-gray-600 dark:text-gray-400">Data de Refer√™ncia</p>
                <p class="text-xs text-gray-500 dark:text-gray-500 mt-1">Data-base da an√°lise</p>
                <p class="text-2xl font-bold text-gray-900 dark:text-white" id="kpi-date">
                    {{ kpis.as_of_date | default('...', true) }}
                </p>
            </div>
            <div class="ml-4 text-gray-500">
                <svg class="w-12 h-12" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd"
                        d="M6 2a1 1 0 00-1 1v1H4a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2h-1V3a1 1 0 10-2 0v1H7V3a1 1 0 00-1-1zm0 5a1 1 0 000 2h8a1 1 0 100-2H6z"
                        clip-rule="evenodd"></path>
                </svg>
            </div>
        </div>
    </div>
</div>

<!-- Charts Section -->
<div class="mb-4">
    <h2 class="text-2xl font-bold text-gray-800 dark:text-white mb-2">üìà An√°lise Visual</h2>
    <p class="text-gray-600 dark:text-gray-400">Gr√°ficos que mostram padr√µes de comportamento e distribui√ß√µes</p>
</div>
<div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
    <!-- Churn by RFM Chart -->
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6">
        <div class="mb-2">
            <h3 class="text-xl font-bold text-gray-900 dark:text-white">üìä Churn por RFM Score</h3>
        </div>
        <p class="text-sm text-gray-600 dark:text-gray-400 mb-3">
            <strong>RFM Score:</strong> M√©dia de R, F e M (1.0 a 5.0). Quanto <strong>menor</strong> a pontua√ß√£o,
            <strong>maior</strong> o risco de churn.
        </p>

        <!-- Legenda de Cores e Explica√ß√£o dos Grupos -->
        <div class="bg-gray-50 dark:bg-gray-700 rounded p-3 mb-4 text-xs">
            <div class="font-bold text-gray-700 dark:text-gray-300 mb-2">üé® Legenda de Risco (cores das barras):</div>
            <div class="grid grid-cols-2 md:grid-cols-5 gap-2">
                <div class="flex items-center">
                    <div class="w-4 h-4 rounded" style="background: rgba(220, 38, 38, 0.8);"></div>
                    <span class="ml-2 text-gray-700 dark:text-gray-300"><strong>1.0-2.0:</strong> Cr√≠tico</span>
                </div>
                <div class="flex items-center">
                    <div class="w-4 h-4 rounded" style="background: rgba(251, 146, 60, 0.8);"></div>
                    <span class="ml-2 text-gray-700 dark:text-gray-300"><strong>2.3-2.7:</strong> Alto</span>
                </div>
                <div class="flex items-center">
                    <div class="w-4 h-4 rounded" style="background: rgba(250, 204, 21, 0.8);"></div>
                    <span class="ml-2 text-gray-700 dark:text-gray-300"><strong>3.0-3.3:</strong> M√©dio</span>
                </div>
                <div class="flex items-center">
                    <div class="w-4 h-4 rounded" style="background: rgba(132, 204, 22, 0.8);"></div>
                    <span class="ml-2 text-gray-700 dark:text-gray-300"><strong>3.7-4.0:</strong> Baixo</span>
                </div>
                <div class="flex items-center">
                    <div class="w-4 h-4 rounded" style="background: rgba(34, 197, 94, 0.8);"></div>
                    <span class="ml-2 text-gray-700 dark:text-gray-300"><strong>4.3-5.0:</strong> √ìtimo</span>
                </div>
            </div>

            <!-- Bot√£o Expans√≠vel -->
            <div class="mt-3 pt-2 border-t border-gray-200 dark:border-gray-600">
                <button onclick="toggleRFMExplanation()"
                    class="flex items-center justify-between w-full text-left font-bold text-gray-700 dark:text-gray-300 hover:text-blue-600 dark:hover:text-blue-400 transition-colors">
                    <span>üìã Como cada grupo √© formado?</span>
                    <svg id="rfmExplanationIcon" class="w-4 h-4 transform transition-transform" fill="currentColor"
                        viewBox="0 0 20 20">
                        <path fill-rule="evenodd"
                            d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z"
                            clip-rule="evenodd"></path>
                    </svg>
                </button>

                <!-- Conte√∫do Expans√≠vel -->
                <div id="rfmExplanationContent" class="hidden mt-2 text-gray-600 dark:text-gray-400 space-y-1">
                    <div><strong>RFM 1.0:</strong> Clientes com R, F e M muito baixos (ex: R=1, F=1, M=1) ‚Üí N√£o compram
                        h√° muito tempo + Poucas compras + Baixo gasto</div>
                    <div><strong>RFM 3.0:</strong> Clientes medianos em todas dimens√µes (ex: R=3, F=3, M=3) ‚Üí
                        Comportamento m√©dio</div>
                    <div><strong>RFM 5.0:</strong> Clientes excelentes em tudo (ex: R=5, F=5, M=5) ‚Üí Compraram
                        recentemente + Muitas compras + Alto gasto</div>
                </div>
            </div>

            <div class="mt-2 text-gray-600 dark:text-gray-400">
                <strong>üí° Interpreta√ß√£o:</strong> Cada barra mostra o <strong>percentual de clientes</strong> dentro
                daquele grupo de RFM que est√£o em churn (inativos >270 dias).
            </div>
        </div>
        <div style="position: relative; height: 300px; max-height: 300px;">
            <canvas id="churnRfmChart"></canvas>
            <!-- Bot√£o de expandir sobreposto no canto superior direito do gr√°fico -->
            <button onclick="expandChartRFM()"
                class="absolute top-2 right-2 bg-white dark:bg-gray-700 bg-opacity-90 hover:bg-opacity-100 text-blue-600 dark:text-blue-400 hover:text-blue-800 dark:hover:text-blue-300 p-2 rounded-lg shadow-md transition-all hover:scale-110 z-10"
                title="Expandir gr√°fico">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5l-5-5m5 5v-4m0 4h-4">
                    </path>
                </svg>
            </button>
        </div>
    </div>

    <!-- Recency Distribution Chart -->
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6">
        <div class="mb-2">
            <h3 class="text-xl font-bold text-gray-900 dark:text-white">üìà Distribui√ß√£o de Rec√™ncia (dias)</h3>
        </div>
        <p class="text-sm text-gray-600 dark:text-gray-400 mb-4">
            <strong>Rec√™ncia:</strong> Quantos dias se passaram desde a √∫ltima compra de cada cliente.
            Valores altos (>270 dias) indicam clientes inativos.
        </p>
        <div style="position: relative; height: 300px; max-height: 300px;">
            <canvas id="recencyHistChart"></canvas>
            <!-- Bot√£o de expandir sobreposto no canto superior direito do gr√°fico -->
            <button onclick="expandChartRecency()"
                class="absolute top-2 right-2 bg-white dark:bg-gray-700 bg-opacity-90 hover:bg-opacity-100 text-blue-600 dark:text-blue-400 hover:text-blue-800 dark:hover:text-blue-300 p-2 rounded-lg shadow-md transition-all hover:scale-110 z-10"
                title="Expandir gr√°fico">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5l-5-5m5 5v-4m0 4h-4">
                    </path>
                </svg>
            </button>
        </div>
    </div>
</div>

<!-- Risk Analysis Section -->
<div class="mb-4 mt-8">
    <h2 class="text-2xl font-bold text-gray-800 dark:text-white mb-2">üö® An√°lise de Risco Detalhada</h2>
    <p class="text-gray-600 dark:text-gray-400">Vis√£o aprofundada dos segmentos de risco e impacto financeiro</p>
</div>

<!-- Risk Summary Cards -->
<div id="riskSummaryCards" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-8">
    <!-- Cards will be injected by JS -->
    <div
        class="col-span-full text-center py-4 bg-white dark:bg-gray-800 rounded shadow animate-pulse text-gray-500 dark:text-gray-400">
        Carregando dados de risco...
    </div>
</div>

<div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
    <!-- Distribution by Segment (Donut) -->
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6 relative">
        <h3 class="text-lg font-bold text-gray-900 dark:text-white mb-4">üë• Distribui√ß√£o de Clientes por Segmento</h3>
        <button onclick="expandRiskDistribution()"
            class="absolute top-2 right-2 bg-white dark:bg-gray-700 bg-opacity-90 hover:bg-opacity-100 text-blue-600 dark:text-blue-400 hover:text-blue-800 dark:hover:text-blue-300 p-2 rounded-lg shadow-md transition-all hover:scale-110 z-10"
            title="Expandir gr√°fico">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5l-5-5m5 5v-4m0 4h-4">
                </path>
            </svg>
        </button>
        <div class="h-64 relative">
            <canvas id="riskDistributionChart"></canvas>
        </div>
    </div>

    <!-- Churn Rate by Segment (Bar) -->
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6 relative">
        <h3 class="text-lg font-bold text-gray-900 dark:text-white mb-4">üìâ Taxa de Churn por Segmento (%)</h3>
        <button onclick="expandRiskChurnRate()"
            class="absolute top-2 right-2 bg-white dark:bg-gray-700 bg-opacity-90 hover:bg-opacity-100 text-blue-600 dark:text-blue-400 hover:text-blue-800 dark:hover:text-blue-300 p-2 rounded-lg shadow-md transition-all hover:scale-110 z-10"
            title="Expandir gr√°fico">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5l-5-5m5 5v-4m0 4h-4">
                </path>
            </svg>
        </button>
        <div class="h-64 relative">
            <canvas id="riskChurnRateChart"></canvas>
        </div>
    </div>

    <!-- Monetary at Risk (Bar) -->
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6 relative">
        <h3 class="text-lg font-bold text-gray-900 dark:text-white mb-4">üí∞ Valor Monet√°rio em Risco (R$)</h3>
        <button onclick="expandRiskMonetary()"
            class="absolute top-2 right-2 bg-white dark:bg-gray-700 bg-opacity-90 hover:bg-opacity-100 text-blue-600 dark:text-blue-400 hover:text-blue-800 dark:hover:text-blue-300 p-2 rounded-lg shadow-md transition-all hover:scale-110 z-10"
            title="Expandir gr√°fico">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5l-5-5m5 5v-4m0 4h-4">
                </path>
            </svg>
        </button>
        <div class="h-64 relative">
            <canvas id="riskMonetaryChart"></canvas>
        </div>
    </div>

    <!-- Risk Funnel (Horizontal Bar sorted by Risk) -->
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6 relative">
        <h3 class="text-lg font-bold text-gray-900 dark:text-white mb-4">üîª Funil de Risco (Volume de Clientes)</h3>
        <button onclick="expandRiskFunnel()"
            class="absolute top-2 right-2 bg-white dark:bg-gray-700 bg-opacity-90 hover:bg-opacity-100 text-blue-600 dark:text-blue-400 hover:text-blue-800 dark:hover:text-blue-300 p-2 rounded-lg shadow-md transition-all hover:scale-110 z-10"
            title="Expandir gr√°fico">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5l-5-5m5 5v-4m0 4h-4">
                </path>
            </svg>
        </button>
        <div class="h-64 relative">
            <canvas id="riskFunnelChart"></canvas>
        </div>
    </div>
</div>

<!-- Export Buttons -->
<div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6 mb-8">
    <h2 class="text-xl font-bold text-gray-900 dark:text-white mb-2">üíæ Exportar Dados</h2>
    <p class="text-sm text-gray-600 dark:text-gray-400 mb-4">Baixe os dados processados em formato CSV para an√°lises
        externas</p>
    <div class="flex flex-wrap gap-4">
        <a href="/export/customers.csv"
            class="bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded inline-flex items-center">
            <svg class="w-4 h-4 mr-2" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd"
                    d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z"
                    clip-rule="evenodd"></path>
            </svg>
            Baixar Todas as Caracter√≠sticas (CSV)
        </a>
        <a href="/export/top_risk.csv"
            class="bg-red-600 hover:bg-red-700 text-white font-medium py-2 px-4 rounded inline-flex items-center">
            <svg class="w-4 h-4 mr-2" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd"
                    d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z"
                    clip-rule="evenodd"></path>
            </svg>
            Baixar Top 50 em Risco (CSV)
        </a>
    </div>
</div>

<!-- Top Risk Table -->
<div class="bg-white dark:bg-gray-800 rounded-lg shadow overflow-hidden">
    <div class="px-6 py-4 border-b border-gray-200 dark:border-gray-700">
        <h2 class="text-xl font-bold text-gray-900 dark:text-white mb-2">‚ö†Ô∏è Top 50 Clientes em Risco</h2>
        <p class="text-sm text-gray-600 dark:text-gray-400">
            Clientes ordenados por <strong>Segmento de Risco</strong> (calculado com base em RFM) que t√™m maior
            probabilidade de churn.
            Use esta lista para priorizar a√ß√µes de reten√ß√£o.
        </p>
    </div>
    <div class="overflow-x-auto">
        <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700" id="topRiskTable">
            <thead class="bg-gray-50 dark:bg-gray-700">
                <tr>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider"
                        title="Identificador √∫nico do cliente">ID do Cliente</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider"
                        title="1 = Em churn (>270 dias inativo), 0 = Ativo">Churn</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider"
                        title="Categoria de risco baseada em RFM (1-8, quanto maior pior)">Segmento de Risco</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider"
                        title="Dias desde a √∫ltima compra">Rec√™ncia (dias)</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider"
                        title="N√∫mero total de pedidos realizados">Frequ√™ncia</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider"
                        title="Valor total gasto pelo cliente (R$)">Valor Monet√°rio</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider"
                        title="M√©dia de R, F e M (1.0-5.0, quanto menor pior)">Pontua√ß√£o RFM</th>
                </tr>
            </thead>
            <tbody class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700" id="topRiskBody">
                <tr>
                    <td colspan="7" class="px-6 py-4 text-center text-gray-500">Carregando...</td>
                </tr>
            </tbody>
        </table>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
    // Controle do Modal de Ajuda
    function toggleHelpModal() {
        const modal = document.getElementById('helpModal');
        modal.classList.toggle('hidden');
        modal.classList.toggle('flex');
    }

    // Controle do Expans√≠vel de Explica√ß√£o RFM
    function toggleRFMExplanation() {
        const content = document.getElementById('rfmExplanationContent');
        const icon = document.getElementById('rfmExplanationIcon');

        content.classList.toggle('hidden');
        icon.classList.toggle('rotate-180');
    }



    // Fun√ß√£o para expandir gr√°fico RFM
    async function expandChartRFM() {
        const modal = document.getElementById('chartModal');
        const title = document.getElementById('chartModalTitle');
        const canvas = document.getElementById('expandedChart');

        title.textContent = 'üìä Churn por RFM Score (Expandido)';
        modal.classList.remove('hidden');
        modal.classList.add('flex');

        // Destruir gr√°fico anterior se existir
        if (expandedChartInstance) {
            expandedChartInstance.destroy();
        }

        // Aguardar o modal renderizar
        await new Promise(resolve => setTimeout(resolve, 50));

        // Recriar gr√°fico com dados da API
        try {
            const response = await fetch('/api/churn_by_rfm');
            const data = await response.json();

            const backgroundColors = data.map(d => {
                const rfmScore = d.RFM_score;
                if (rfmScore <= 2.0) return 'rgba(220, 38, 38, 0.8)';
                else if (rfmScore <= 2.7) return 'rgba(251, 146, 60, 0.8)';
                else if (rfmScore <= 3.3) return 'rgba(250, 204, 21, 0.8)';
                else if (rfmScore <= 4.0) return 'rgba(132, 204, 22, 0.8)';
                else return 'rgba(34, 197, 94, 0.8)';
            });

            expandedChartInstance = new Chart(canvas, {
                type: 'bar',
                data: {
                    labels: data.map(d => `RFM ${d.RFM_score}`),
                    datasets: [{
                        label: 'Taxa de Churn (%)',
                        data: data.map(d => d.churn_rate),
                        backgroundColor: backgroundColors,
                        borderWidth: 2,
                        borderRadius: 4,
                        barPercentage: 0.8,
                        categoryPercentage: 0.9
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    layout: {
                        padding: {
                            left: 20,
                            right: 20,
                            top: 20,
                            bottom: 20
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100,
                            ticks: {
                                callback: value => value + '%',
                                font: { size: 16, weight: 'bold' },
                                padding: 10
                            },
                            title: {
                                display: true,
                                text: '% de Clientes em Churn',
                                font: { size: 18, weight: 'bold' },
                                padding: { top: 10, bottom: 10 }
                            },
                            grid: {
                                color: 'rgba(0, 0, 0, 0.1)'
                            }
                        },
                        x: {
                            ticks: {
                                font: { size: 16, weight: 'bold' },
                                padding: 10
                            },
                            title: {
                                display: true,
                                text: 'RFM Score',
                                font: { size: 18, weight: 'bold' },
                                padding: { top: 10, bottom: 10 }
                            },
                            grid: {
                                display: false
                            }
                        }
                    },
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            enabled: true,
                            backgroundColor: 'rgba(0, 0, 0, 0.9)',
                            padding: 16,
                            titleFont: { size: 18, weight: 'bold' },
                            bodyFont: { size: 15 },
                            callbacks: {
                                label: function (context) {
                                    const index = context.dataIndex;
                                    const dataPoint = data[index];

                                    // Verifica√ß√£o de seguran√ßa
                                    if (!dataPoint || dataPoint.total_customers === undefined) {
                                        return `üìä Taxa de Churn: ${context.parsed.y.toFixed(1)}%`;
                                    }

                                    const totalClientes = dataPoint.total_customers;
                                    const churnRate = dataPoint.churn_rate;
                                    const clientesChurn = Math.round(totalClientes * churnRate / 100);

                                    return [
                                        `üìä Taxa de Churn: ${churnRate.toFixed(1)}%`,
                                        `üë• Total: ${totalClientes.toLocaleString('pt-BR')} clientes`,
                                        `‚ùå Em churn: ${clientesChurn.toLocaleString('pt-BR')}`,
                                        `‚úÖ Ativos: ${(totalClientes - clientesChurn).toLocaleString('pt-BR')}`
                                    ];
                                }
                            }
                        }
                    }
                }
            });
        } catch (error) {
            console.error('Erro ao expandir gr√°fico:', error);
        }
    }


</script>
<script src="{{ url_for('static', filename='js/dashboard.js') }}"></script>
{% endblock %}